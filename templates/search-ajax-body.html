<!-- The compose box lives here! -->
<form method="GET" onsubmit="fetchSearch(this); return false;">
    <div class="mini-compose-box border-bottom border-dark px-3 p-2 d-flex flex-row">
        <input class="w-100 mr-2" type="text" name="q" placeholder="search query" value="{{query if query else ''}}" {{'' if query else 'autofocus'}} required>
        <div class="d-inline-block ml-2">
            <button type="submit" class="btn btn-primary rounded-pill mini-btn search-btn"><strong>Search</strong></button>
        </div>
    </div>
</form>

<meta name="page-number" content={{page_n}}>
<meta name="query" {% if query %} content={{query}} {% endif %}>

<div id="dynamic-content">
    <!-- Content loading indicator -->
    <div class="content-loading-indicator d-none">
        {% if slow_connection %}
        <svg xmlns="http://www.w3.org/2000/svg" width="963.625" height="629.032" viewBox="0 0 963.625 629.032">
            <path id="claw_2" data-name="claw 2" class="cls-1" d="M979.339,278.832a121.009,121.009,0,0,1-90.236,93.48c-0.089-.23-0.188-0.457-0.279-0.687a234.619,234.619,0,0,1-155,119.608c0.108,2.91.175,5.83,0.175,8.767a233.571,233.571,0,0,1-13.16,77.506,183.9,183.9,0,0,1,196.483,72.747,277.844,277.844,0,0,0-192.879-13.776,172.376,172.376,0,0,1,88.69,121.45,260.675,260.675,0,0,0-160.645-87.458,116.841,116.841,0,0,1,54.142,104.212A176.325,176.325,0,0,0,613.538,692.3q-7.012,9.54-13.654,19.361a234.427,234.427,0,0,1-199.768,0q-6.63-9.828-13.654-19.361a176.33,176.33,0,0,0-93.1,82.406,116.843,116.843,0,0,1,54.1-104.224,260.67,260.67,0,0,0-160.579,87.44,172.363,172.363,0,0,1,88.7-121.436A277.843,277.843,0,0,0,82.677,650.253,183.894,183.894,0,0,1,279.16,577.506,233.571,233.571,0,0,1,266,500c0-2.937.066-5.857,0.174-8.768a234.617,234.617,0,0,1-155-119.607c-0.091.23-.19,0.457-0.279,0.687A121.032,121.032,0,0,1,86.643,145.648,134.56,134.56,0,0,0,61.9,211.041c-1.105,11.237-.692,24.582,2.1,40.072C70.435,286.86,86.969,309.237,96,315c7.226,4.611,17.547,8.524,32.379,9.452a78.061,78.061,0,0,0,33.308-5.24c0.112,0.187.229,0.372,0.342,0.559a90.119,90.119,0,0,0,47.916-80.2,91,91,0,0,1-24.546,114.4,353.361,353.361,0,0,0,91.027,83.038,455.361,455.361,0,0,1,65.457-30.11A43,43,0,0,0,423,387c0-.541-0.021-1.078-0.041-1.614a461.8,461.8,0,0,1,154.077.171c-0.015.48-.036,0.959-0.036,1.443a43,43,0,0,0,80.959,20.2,455.3,455.3,0,0,1,65.143,30.1,353.354,353.354,0,0,0,91.5-83.336,91,91,0,0,1-24.546-114.4,90.119,90.119,0,0,0,47.916,80.2c0.113-.187.23-0.372,0.342-0.559a78.061,78.061,0,0,0,33.308,5.24c14.832-.928,25.153-4.841,32.379-9.452,9.031-5.763,25.565-28.14,32-63.887,2.79-15.49,3.2-28.836,2.1-40.074a134.55,134.55,0,0,0-24.743-65.391A121.045,121.045,0,0,1,979.339,278.832ZM619.5,423A34.5,34.5,0,1,1,654,388.5,34.5,34.5,0,0,1,619.5,423Zm-239,0A34.5,34.5,0,1,1,415,388.5,34.5,34.5,0,0,1,380.5,423Z" transform="translate(-18.188 -145.656)"/>
        </svg>
        {% else %}
        <!-- Animated logo -->
        <img src="https://cdn.crabber.net/img/content-loading-indicator.gif">
        {% endif %}
        <!-- Spacer -->
        <div class="d-inline-block w-100 p-5 my-5 text-muted text-molt text-center"></div>
    </div>
    <div class="content-loading-failed d-none">
        <a href="javascript:loadContent();">failed to load content :(<br>click to try again.</a>
    </div>

    <!-- Display search results here once loaded -->
    <div id="search-results">
        <!-- Pre-search quote -->
        <div id="ps-quote" class="d-inline-block w-100 p-5 text-muted text-molt text-center"><em>"The world is your lobster."</em> - Christian D.</div>
    </div>
</div>

<!-- Spacer -->
<div class="d-inline-block w-100 p-5 my-5 text-muted text-molt text-center"></div>

<script>
    // Ajax history handler
    window.onpopstate = function(e) {
        if(e.state) {
            // Going back to pre-search state
            if (e.state.query === null) {
                // Update query box
                $("input[name=q]").val("");

                $('meta[name="query"]').removeAttr("content")
                $('meta[name="page-number"]').attr("content", 1);

                $("#search-results").empty();
                $("#search-results").append(e.state.html);
            }

            // Update query box
            $("input[name=q]").val(e.state.query);

            $('meta[name="query"]').attr("content", e.state.query);
            $('meta[name="page-number"]').attr("content", e.state.page);

            $("#search-results").empty();
            $("#search-results").append(e.state.html);
        }
    };

    function insertBodyHTML(data) {
        let pNum = parseInt($('meta[name="page-number"]').attr("content"));
        let query = $('meta[name="query"]').attr("content");
        window.history.pushState({'html': data, 'query': query, 'page': pNum}, "Search | Crabber", `/search/?q=${query}&p=${pNum}`);
        $("#search-results").append(data);
        $(".content-loading-indicator").addClass("d-none");
    }
    // Display load failure to user
    function contentLoadError() {
        $(".content-loading-failed").removeClass("d-none");
        $(".content-loading-indicator").addClass("d-none");
    }

    // Build request from form data
    function fetchSearch(form) {
        var query = form.q.value.trim();

        // Query empty...
        if (query === "") {
            return false;
        }

        loadContent(query, 1);
    }

    // Fetch search results from server and display them
    function loadContent(query=null, page=null) {
        if (query === null) {
            query = $('meta[name="query"]').attr("content");
        }
        else {
            $('meta[name="query"]').attr("content", query);
        }
        if (page === null) {
            page = parseInt($('meta[name="page-number"]').attr("content"));
        }
        else {
            $('meta[name="page-number"]').attr("content", page);
        }

        // Remove previous search results / pre-search quote
        $("#search-results").empty();

        // Loading indicator
        $(".content-loading-indicator").removeClass("d-none");
        $(".content-loading-failed").addClass("d-none");

        $.ajax({
            url: '/search',
            type: 'GET',
            data: {'q': query, 'p': page, 'ajax_content': true},
            success: insertBodyHTML,
            error: contentLoadError
        });
    }

    // Do Ajax request on load if query is set
    if ($('meta[name="query"]').attr("content")) {
        loadContent();
    }
    // Create history state to fall back on
    else {
        window.history.pushState({'html': $("#search-results").html(), 'query': null, 'page': 1}, "Search | Crabber", '/search');
    }

    // Molt/Like tab controller
    function switchTo(tab) {
        if (tab == "molts") {
            // Switch active button
            $("#molts-btn").addClass("active");
            $("#crabs-btn").removeClass("active");
            // Switch tab
            $("#molts").removeClass("d-none");
            $("#crabs").addClass("d-none");
        }
        else if (tab == "crabs") {
            // Switch active button
            $("#crabs-btn").addClass("active");
            $("#molts-btn").removeClass("active");
            // Switch tab
            $("#crabs").removeClass("d-none");
            $("#molts").addClass("d-none");
        }
    }
</script>
